worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # Optimization Step 5
    sendfile        on;
    tcp_nopush      on;
    keepalive_timeout  65;

    # Gzip Settings
    gzip on;
    gzip_types application/vnd.apple.mpegurl;
    gzip_min_length 1000;

    server {
        listen       80;
        server_name  localhost;

        # ---------------------------------------------------------
        # 1. API & Key Provider (Reverse Proxy to Node.js)
        # ---------------------------------------------------------
        location /v1/ {
            proxy_pass http://localhost:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ---------------------------------------------------------
        # 2. Protected Video Content ("The Moat")
        # ---------------------------------------------------------
        location /videos/ {
            # UPDATE THIS PATH to your actual video storage directory
            alias "D:/Encryption Learning Platfrom/backend/public/private_videos/";
            
            # -----------------------------------------------------
            # Secure Link Module Configuration
            # -----------------------------------------------------
            # 1. Extract md5 and expires from URL query params
            secure_link $arg_md5,$arg_expires;

            # 2. Verify the hash
            # Logic: md5(expires + uri + " " + secret)
            # Corresponds to Node.js: `${expires}${path} ${secret}`
            secure_link_md5 "$arg_expires$uri YOUR_SHARED_SECRET_FROM_ENV";

            # 3. Handle Errors
            if ($secure_link = "") { 
                return 403; # Forbidden (Invalid or missing signature)
            }
            if ($secure_link = "0") { 
                return 410; # Gone (Link expired)
            }

            # 4. HLS & CORS Configuration
            add_header Access-Control-Allow-Origin "*";
            add_header Cache-Control "no-cache";

            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
        }
    }
}
